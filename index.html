<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contabilizador de Horas</title>
  <!-- Añade la meta viewport para responsividad -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8; color: #23272e;
      transition: background 0.5s, color 0.5s;
    }
    .container {
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      height: 100vh; text-align: center;
      padding: 0 10px;
    }
    .card {
      background: white; padding: 30px 40px; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; width: 100%;
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
    .nombre-container { margin-bottom: 20px; }
    input[type="text"], input[type="number"] {
      padding: 10px; width: 100%; font-size: 16px;
      border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px;
      background: #fff; color: #23272e; transition: background 0.3s, border 0.3s, color 0.3s;
      box-sizing: border-box;
    }
    .btn {
      background: linear-gradient(90deg, #4A90E2 60%, #357ABD 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      margin: 10px 5px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #4a90e220;
      outline: none;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s, transform 0.2s;
      letter-spacing: 0.5px;
    }
    .btn:hover {
      background: linear-gradient(90deg, #357ABD 60%, #4A90E2 100%);
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #4a90e240;
    }
    .btn-contingencia {
      background: linear-gradient(90deg, #f7b731 60%, #f97f51 100%) !important;
      color: #23272e !important;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 8px #f7b73140;
    }
    .btn-contingencia:hover {
      background: linear-gradient(90deg, #f97f51 60%, #f7b731 100%) !important;
      color: #23272e !important;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #f7b73160;
    }
    .btn-admin {
      background: linear-gradient(135deg, #4A90E2 60%, #43b97b 100%);
      color: #fff;
      position:fixed;bottom:24px;right:24px;z-index:300;
      font-size:22px;
      padding: 13px;
      border-radius: 50%;
      border:none;
      box-shadow:0 2px 8px #4a90e220;cursor:pointer;
      transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-admin:hover {
      background: linear-gradient(135deg, #43b97b 60%, #4A90E2 100%);
      transform: scale(1.08);
      box-shadow: 0 4px 16px #43b97b40;
    }
    .btn-darkmode {
      position:fixed;top:18px;right:24px;z-index:200;
      font-size:22px;
      padding: 13px;
      border-radius: 50%;
      border:none;
      box-shadow:0 2px 8px #0002;
      cursor:pointer;
      background: linear-gradient(135deg, #fff 60%, #e0e6ef 100%);
      color: #23272e;
      transition: background 0.4s, color 0.4s, box-shadow 0.3s, transform 0.2s;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-darkmode:hover {
      background: linear-gradient(135deg, #e0e6ef 60%, #fff 100%);
      color: #357abd;
      transform: scale(1.08);
      box-shadow: 0 4px 16px #4a90e220;
    }
    .btn-eliminar {
      background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px #e74c3c40 !important;
      border: none !important;
      margin: 10px 5px !important;
    }
    .btn-eliminar:hover {
      background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
      color: #fff !important;
      transform: translateY(-2px) scale(1.04) !important;
      box-shadow: 0 4px 16px #e74c3c60 !important;
    }
    /* Botón especial para cambiar clave - amarillo auyama sólido */
    .btn-cambiar-clave {
      background: #e1a700 !important; /* amarillo auyama */
      color: #23272e !important;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 8px #e1a70033;
      margin-top: 8px;
      width: 100%;
      font-size: 1.1rem;
      padding: 12px 0 12px 0;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
    }
    .btn-cambiar-clave:hover {
      background: #b8860b !important; /* un poco más oscuro al pasar el mouse */
      color: #fffbe6 !important;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #e1a70055;
    }

    /* Modo oscuro para el botón cambiar clave */
    body.manual-dark .btn-cambiar-clave {
      background: #e6a503 !important; /* amarillo auyama oscuro */
      color: #fffbe6 !important;
      box-shadow: 0 2px 8px #b8860b55;
    }
    body.manual-dark .btn-cambiar-clave:hover {
      background: #e1a700 !important;
      color: #23272e !important;
      box-shadow: 0 4px 16px #ffc00177;
    }
    body.manual-dark .btn,
    body.manual-dark .btn-contingencia,
    body.manual-dark .btn-admin,
    body.manual-dark .btn-darkmode,
    body.manual-dark .btn-eliminar,
    body.manual-dark .btn-enviar {
      filter: none !important;
      opacity: 1 !important;
      color: inherit;
    }
    body.manual-dark .btn-eliminar {
    background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
    color: #fff !important;
    border: none !important;
    }
    body.manual-dark .btn-eliminar:hover {
    background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
    color: #fff !important;
    }
    .info p { font-size: 16px; color: #555; margin: 10px 0; }
    .info span { font-weight: bold; color: #222; }
    .historial { margin-top: 30px; text-align: left; max-height: 200px; overflow-y: auto; border-top: 1px solid #ddd; padding-top: 15px; }
    .historial-item {
      font-size: 15px; margin-bottom: 18px; background: linear-gradient(120deg, #f7fafd 80%, #e3e8ee 100%);
      padding: 16px 20px 12px 20px; border-radius: 14px; color: #23272e; box-shadow: 0 4px 18px #4a90e220;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
    }
    .historial-item strong { color: #357abd; font-size: 17px; font-weight: 700; margin-right: 6px; }
    .historial-item .historial-motivo { color: #f97f51; font-weight: 600; font-size: 15px; margin-left: 2px; }
    .historial-item .historial-monto { color: #43b97b; font-weight: 600; font-size: 15px; margin-left: 2px; }
    .historial-item .historial-fecha { color: #888; font-size: 13px; margin-top: 2px; display: block; }
    .historial-item .historial-extra { color: #357abd; font-size: 14px; margin-top: 2px; display: block; }
    body.manual-dark { background: #181c20 !important; color: #e0e6ef !important; }
    .manual-dark .card { background: #23272e !important; color: #e0e6ef !important; box-shadow: 0 10px 25px rgba(0,0,0,0.25) !important; }
    .manual-dark input[type="text"], .manual-dark input[type="number"] { background: #2c3e50 !important; color: #eaf6fb !important; border: 1.5px solid #4a90e2 !important; }
    .manual-dark input[type="text"]::placeholder, .manual-dark input[type="number"]::placeholder { color: #b3c6e0 !important; opacity: 0.8; }
    .manual-dark .btn { background: #3b6cb7 !important; color: #fff !important; }
    .manual-dark .btn:hover { background: #5fa8d3 !important; }
    .manual-dark .btn-contingencia { background: linear-gradient(90deg, #f7b731 60%, #f97f51 100%) !important; color: #23272e !important; }
    .manual-dark .info p { color: #b3c6e0 !important; }
    .manual-dark .info span { color: #e0e6ef !important; }
    .manual-dark .historial { border-top: 1px solid #3b4a5a !important; }
    .manual-dark .historial-item { background: #23272e !important; color: #e0e6ef !important; box-shadow: 0 1px 6px #0004 !important; }
    .manual-dark .historial-item strong { color: #43e97b !important; }
    .manual-dark .historial-item .historial-motivo { color: #f7b731 !important; }
    .manual-dark .historial-item .historial-monto { color: #43e97b !important; }
    .manual-dark .historial-item .historial-fecha { color: #b3c6e0 !important; }
    .manual-dark h1 { color: #e0e6ef !important; }
    #darkModeToggle { transition: background 0.4s, color 0.4s; }

    /* Animación para el modal de login */
    #loginModal > div {
      animation: loginPop 0.6s cubic-bezier(.23,1.12,.56,1.01);
    }
    @keyframes loginPop {
      0% { transform: scale(0.7) translateY(40px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* --- Panel administrativo modo oscuro: gama mejorada y detalles visuales --- */
body.manual-dark #adminModal,
body.manual-dark #adminModal.manual-dark {
  background: rgba(18, 22, 34, 0.98) !important;
  backdrop-filter: blur(3px);
}
body.manual-dark #adminModal > div,
body.manual-dark #adminPanel {
  background: linear-gradient(120deg, #23283a 70%, #1e2233 100%) !important;
  color: #e3eafc !important;
  border-radius: 18px !important;
  box-shadow: 0 8px 32px #000b !important;
  border: 1.5px solid #27304a !important;
  padding: 32px 24px 24px 24px !important;
  max-width: 700px;
  width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
body.manual-dark #adminModal h2, 
body.manual-dark #adminModal h3 {
  color: #7fd7ff !important;
  letter-spacing: 0.5px;
  margin-bottom: 14px;
}
body.manual-dark #adminModal input, 
body.manual-dark #adminModal select {
  background: #232c3d !important;
  color: #e3eafc !important;
  border: 1.5px solid #3b4a6b !important;
  border-radius: 7px !important;
  padding: 8px 10px !important;
  margin-bottom: 6px;
}
body.manual-dark #adminModal input::placeholder {
  color: #8fa2c7 !important;
  opacity: 0.8;
}
body.manual-dark #adminModal table {
  background: #23283a !important;
  color: #e3eafc !important;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px #1e233340;
  margin-bottom: 18px;
}
body.manual-dark #adminModal th {
  background: #27304a !important;
  color: #7fd7ff !important;
  border: 1px solid #3b4a6b !important;
  font-weight: 600;
  padding: 10px 8px;
}
body.manual-dark #adminModal td {
  background: #23283a !important;
  color: #e3eafc !important;
  border: 1px solid #27304a !important;
  padding: 9px 8px;
}
body.manual-dark #adminModal tr:nth-child(even) td {
  background: #232c3d !important;
}
body.manual-dark #adminModal tr:hover td {
  background: #2e3650 !important;
  color: #fff !important;
  transition: background 0.2s, color 0.2s;
}
body.manual-dark #adminModal .btn,
body.manual-dark #adminModal .btn-enviar {
  background: linear-gradient(90deg, #3b4a6b 60%, #1e2a3a 100%) !important;
  color: #7fd7ff !important;
  border: none !important;
  box-shadow: 0 2px 8px #7fd7ff22 !important;
  font-weight: bold;
  border-radius: 7px !important;
}
body.manual-dark #adminModal .btn:hover,
body.manual-dark #adminModal .btn-enviar:hover {
  background: linear-gradient(90deg, #1e2a3a 60%, #3b4a6b 100%) !important;
  color: #fff !important;
  box-shadow: 0 4px 16px #7fd7ff44 !important;
}
body.manual-dark #adminModal .btn-eliminar {
  background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #e74c3c40 !important;
}
body.manual-dark #adminModal .btn-eliminar:hover {
  background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
  color: #fff !important;
  box-shadow: 0 4px 16px #e74c3c60 !important;
}
body.manual-dark #adminModal .btn-contingencia {
  background: linear-gradient(90deg, #ffe082 60%, #ffb74d 100%) !important;
  color: #23272e !important;
  box-shadow: 0 2px 8px #ffe08240 !important;
}
body.manual-dark #adminModal .btn-contingencia:hover {
  background: linear-gradient(90deg, #ffb74d 60%, #ffe082 100%) !important;
  color: #23272e !important;
  box-shadow: 0 4px 16px #ffe08260 !important;
}
body.manual-dark #adminModal ul {
  background: none !important;
  padding: 0;
}
body.manual-dark #adminModal li {
  background: #232c3d !important;
  color: #e3eafc !important;
  border-radius: 7px;
  margin-bottom: 6px;
  padding: 6px 10px;
  display: flex;
  align-items: center;
  box-shadow: 0 1px 4px #0002;
}
body.manual-dark #adminModal li b {
  color: #7fd7ff !important;
}
body.manual-dark #adminModal select {
  background: #232c3d !important;
  color: #7fd7ff !important;
  border: 1.5px solid #3b4a6b !important;
}
body.manual-dark #adminModal #usuariosLista button {
  margin-left: 6px;
}
body.manual-dark #adminModal #closeAdminModal {
  color: #7fd7ff !important;
  background: none !important;
  border-radius: 50% !important;
  transition: background 0.2s, color 0.2s;
}
body.manual-dark #adminModal #closeAdminModal:hover {
  color: #fff !important;
  background: #2e3650 !important;
}
body.manual-dark #adminModal div[style*="background:#f7fafd"] {
  background: #27304a !important;
  color: #7fd7ff !important;
  box-shadow: 0 2px 10px #7fd7ff22 !important;
}
body.manual-dark #adminModal span[style*="color:#357abd"] {
  color: #7fd7ff !important;
}
body.manual-dark #adminModal span[style*="color:#43b97b"] {
  color: #43e97b !important;
}
/* --- Fin panel administrativo modo oscuro --- */
  </style>
</head>
<body>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script type="module">
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDhgZV2UsMn04-z4AgP_cYB5IYfm-P9zZU",
      authDomain: "contador-de-hs-extras.firebaseapp.com",
      databaseURL: "https://contador-de-hs-extras-default-rtdb.firebaseio.com",
      projectId: "contador-de-hs-extras",
      storageBucket: "contador-de-hs-extras.firebasestorage.app",
      messagingSenderId: "965974169282",
      appId: "1:965974169282:web:f94b2ed159a5c1897a4d5b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Haz db global para que esté disponible en los handlers de ventana
    window.db = db;

    // --- Utilidades ---
    let inicio = null, usuarioActual = null, rolActual = null;

    const obtenerHoraLocalVE = (date = new Date()) =>
      new Date(date.toLocaleString("en-US", { timeZone: "America/Caracas" }));
    const formatearHora = date =>
      date.toLocaleTimeString("es-VE", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

    // --- Login ---
    function mostrarLogin() {
      document.getElementById('loginModal').style.display = 'flex';
    }
    function ocultarLogin() {
      document.getElementById('loginModal').style.display = 'none';
    }
    function setAdminBtnByRol(rol) {
      document.getElementById('adminBtn').style.display = rol === 'superadmin' ? 'flex' : 'none';
    }
    // Al hacer login, marcar usuario como conectado
    document.getElementById('loginBtn').onclick = function() {
      const usuario = document.getElementById('loginUsuario').value.trim().toLowerCase();
      const clave = document.getElementById('loginClave').value.trim();
      db.ref('usuarios/' + usuario).once('value', snap => {
        const data = snap.val();
        if (data && data.clave === clave) {
          usuarioActual = usuario;
          rolActual = data.rol;
          ocultarLogin();
          document.getElementById('nombre').value = usuario;
          setAdminBtnByRol(rolActual);
          // Marcar como conectado
          db.ref('usuarios/' + usuario + '/conectado').set(true);
          // Al cerrar o recargar, marcar como desconectado
          window.addEventListener('beforeunload', () => {
            db.ref('usuarios/' + usuario + '/conectado').set(false);
          });
          cargarHistorialUsuario();
        } else {
          document.getElementById('loginError').textContent = 'Usuario o clave incorrectos';
          document.getElementById('loginError').style.display = 'block';
        }
      });
    };
    ['loginUsuario', 'loginClave'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('loginBtn').click();
      });
    });

    // --- Modo oscuro ---
    function aplicarModoOscuro() {
      const dark = localStorage.getItem('modo_oscuro') === '1';
      document.body.classList.toggle('manual-dark', dark);
      const btn = document.getElementById('darkModeToggle');
      btn.textContent = dark ? '☀️' : '🌙';
      btn.style.background = dark ? '#23272e' : '#fff';
      btn.style.color = dark ? '#e0e6ef' : '#23272e';
    }
    document.getElementById('darkModeToggle').onclick = () => {
      const dark = !(localStorage.getItem('modo_oscuro') === '1');
      localStorage.setItem('modo_oscuro', dark ? '1' : '0');
      aplicarModoOscuro();
    };

    // --- Inicio y Fin ---
    window.marcarInicio = function() {
      const nombre = document.getElementById("nombre").value.trim();
      if (!nombre) {
        Swal.fire('Campo requerido', 'Por favor, ingresa un nombre.', 'warning');
        return;
      }
      const motivo = document.getElementById("motivo").value.trim();
      if (!motivo) {
        Swal.fire('Campo requerido', 'Por favor, ingresa un motivo.', 'warning');
        return;
      }
      inicio = obtenerHoraLocalVE();
      document.getElementById("horaInicio").textContent = formatearHora(inicio);
      document.getElementById("horaFin").textContent = "-";
      document.getElementById("duracion").textContent = "-";
      localStorage.setItem('inicio_pendiente', JSON.stringify({ nombre, motivo, inicio: inicio.toISOString() }));
    };
    window.marcarFin = function() {
      if (!inicio) {
        Swal.fire('Atención', 'Primero marca la hora de inicio.', 'warning');
        return;
      }
      const nombre = document.getElementById("nombre").value.trim();
      if (!nombre) {
        Swal.fire('Campo requerido', 'Por favor, ingresa un nombre.', 'warning');
        return;
      }
      let motivo = document.getElementById("motivo").value.trim();
      let monto = 0;
      let inicioPend = localStorage.getItem('inicio_pendiente');
      let contingencia = false;
      if (inicioPend) {
        let data = JSON.parse(inicioPend);
        contingencia = !!data.contingencia;
      }
      if (contingencia) {
        motivo += (motivo ? ' | ' : '') + 'Contingencia: 10 USDT';
        monto += 10;
      }
      const fin = obtenerHoraLocalVE();
      document.getElementById("horaFin").textContent = formatearHora(fin);
      const duracionMs = fin - inicio;
      const segundos = Math.floor(duracionMs / 1000);
      const minutos = Math.floor(segundos / 60);
      const horas = Math.floor(minutos / 60);
      const restoMin = minutos % 60;
      const restoSeg = segundos % 60;
      const duracionTexto = `${horas}h ${restoMin}m ${restoSeg}s`;
      const hoy = obtenerHoraLocalVE();
      const dia = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0') + '-' + String(hoy.getDate()).padStart(2,'0');
      const registro = { nombre, motivo, dia, inicio: formatearHora(inicio), fin: formatearHora(fin), duracion: duracionTexto };
      if (monto > 0) registro.monto = monto.toFixed(2);
      db.ref('registros').push(registro);
      inicio = null;
      localStorage.removeItem('inicio_pendiente');
    };

    window.agregarMotivoTrabajo = function() {
      const motivoTrabajo = document.getElementById("motivoTrabajo").value.trim();
      const montoPagar = document.getElementById("montoPagar").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      if (!motivoTrabajo) {
        Swal.fire('Campo requerido', 'Por favor, ingresa el motivo del trabajo.', 'warning');
        return;
      }
      if (!montoPagar || isNaN(montoPagar)) {
        Swal.fire('Campo requerido', 'Por favor, ingresa solo números en el monto a pagar.', 'warning');
        return;
      }
      if (!nombre) {
        Swal.fire('Campo requerido', 'Por favor, ingresa tu nombre.', 'warning');
        return;
      }
      const hoy = new Date();
      const fecha = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0') + '-' + String(hoy.getDate()).padStart(2,'0');
      const registro = { nombre, motivo: motivoTrabajo, monto: montoPagar, dia: fecha };
      db.ref('registros').push(registro);
      document.getElementById("motivoTrabajo").value = "";
      document.getElementById("montoPagar").value = "";
      Swal.fire('¡Listo!', 'Motivo de trabajo registrado correctamente.', 'success');
    };

    document.getElementById("contingenciaBtn").onclick = function() {
      if (!inicio) {
        Swal.fire('Atención', 'Debes iniciar las horas extras.', 'warning');
        return;
      }
      let inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) {
        let data = JSON.parse(inicioPend);
        data.contingencia = true;
        localStorage.setItem('inicio_pendiente', JSON.stringify(data));
      }
      Swal.fire('Contingencia', 'La contingencia se sumará al siguiente registro cuando marques fin.', 'info');
    };

    // --- Historial y resumen en tiempo real desde Firebase ---
    function mostrarHistorialFirebase(registros) {
      const historial = document.getElementById("historial");
      historial.innerHTML = "<strong>Histórico de tiempos:</strong><div id='resumenHoras'></div>";
      registros.forEach((registro) => {
        const item = document.createElement("div");
        item.className = "historial-item";
        let fechaDMY = '-';
        if (registro.dia) {
          const [y, m, d] = registro.dia.split('-');
          fechaDMY = `${d}-${m}-${y}`;
        }
        let html = `<strong>👤</strong> ${registro.nombre}`;
        if (registro.motivo) html += `<span class='historial-motivo'> | ${registro.motivo}</span>`;
        if (registro.monto) html += `<span class='historial-monto'> | ${registro.monto} USDT</span>`;
        html += `<span class='historial-fecha'>📅 ${fechaDMY}</span>`;
        if (registro.inicio && registro.fin) html += `<span class='historial-extra'>⏰ ${registro.inicio} - ${registro.fin}</span>`;
        if (registro.duracion) html += `<span class='historial-extra'>⏳ ${registro.duracion}</span>`;
        item.innerHTML = html;
        historial.appendChild(item);
      });
    }
    function actualizarResumenHorasFirebase(registros) {
      let totalMin = 0, monto = 0;
      registros.forEach(r => {
        if (r.duracion) {
          const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
          if (match) totalMin += parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
        }
        if (r.monto && !isNaN(r.monto)) monto += parseFloat(r.monto);
      });
      monto += totalMin * 0.025;
      const horas = Math.floor(totalMin / 60);
      const mins = totalMin % 60;
      // Cambia a dos decimales:
      document.getElementById("resumenHoras").textContent = `Horas trabajadas: ${horas}h ${mins}m (Total: ${monto.toFixed(2)} USDT)`;
    }

    // Solo mostrar el historial del usuario logueado y conservarlo siempre en Firebase
    function cargarHistorialUsuario() {
      const usuario = usuarioActual || document.getElementById('nombre').value.trim().toLowerCase();
      db.ref('registros').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registrosFirebase = Object.values(data);
        // Filtrar solo los registros del usuario actual
        const registrosUsuario = registrosFirebase.filter(r => r.nombre && r.nombre.toLowerCase() === usuario);
        mostrarHistorialFirebase(registrosUsuario);
        actualizarResumenHorasFirebase(registrosUsuario);
      });
    }

    // --- Panel admin y gestión de usuarios ---
    document.getElementById('adminBtn').onclick = function() {
      if (rolActual === 'superadmin') {
        mostrarPanelAdmin();
      }
    };
    document.getElementById('closeAdminModal').onclick = function() {
      document.getElementById('adminModal').style.display = 'none';
    };
    function mostrarPanelAdmin() {
      db.ref('registros').once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registros = Object.values(data);
        const resumen = {};
        let totalMin = 0, totalMontos = 0;
        registros.forEach(r => {
          const key = r.nombre + '|' + (r.motivo || '-');
          if(!resumen[key]) resumen[key] = {min:0, count:0, monto:0, motivo: r.motivo || '-'};
          if(r.duracion) {
            const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
            if(match) {
              const min = parseInt(match[1])*60 + parseInt(match[2]);
              resumen[key].min += min;
              totalMin += min;
            }
          }
          if(r.monto && !isNaN(r.monto)) {
            resumen[key].monto += parseFloat(r.monto);
            totalMontos += parseFloat(r.monto);
          }
          resumen[key].count++;
        });
        const resumenOrdenado = Object.entries(resumen).sort((a, b) => {
          const [nombreA, motivoA] = a[0].split('|');
          const [nombreB, motivoB] = b[0].split('|');
          if (nombreA === nombreB) return motivoA.localeCompare(motivoB);
          return nombreA.localeCompare(nombreB);
        });
        let resumenHtml = `
          <div style='overflow-x:auto; margin-bottom:18px;'>
            <h3 style='margin:0 0 8px 0;font-size:1.3rem;'>Resumen General</h3>
            <table style='border-collapse:collapse;width:100%;min-width:400px;'>
              <thead>
                <tr style='background:#f7fafd;'>
                  <th style='border:1px solid #ccc;padding:8px;'>Nombre</th>
                  <th style='border:1px solid #ccc;padding:8px;'>Motivo</th>
                  <th style='border:1px solid #ccc;padding:8px;'>Horas</th>
                  <th style='border:1px solid #ccc;padding:8px;'>Minutos</th>
                  <th style='border:1px solid #ccc;padding:8px;'>Registros</th>
                  <th style='border:1px solid #ccc;padding:8px;'>Monto Total (USDT)</th>
                </tr>
              </thead>
              <tbody>
        `;
        resumenOrdenado.forEach(([key, data]) => {
          const [nombre, motivo] = key.split('|');
          const h = Math.floor(data.min/60), m = data.min%60;
          const montoTiempo = data.min * 0.025;
          const montoTotal = montoTiempo + data.monto;
          resumenHtml += `
            <tr>
              <td style='border:1px solid #ccc;padding:8px;'>${nombre}</td>
              <td style='border:1px solid #ccc;padding:8px;'>${motivo}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${h}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${m}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${data.count}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${montoTotal.toFixed(2)}</td>
            </tr>
          `;
        });
        resumenHtml += `
              </tbody>
            </table>
          </div>
        `;
        let totalUSDT = (totalMin * 0.025 + totalMontos).toFixed(2);
        resumenHtml += `<div style='background:#f7fafd;border-radius:12px;padding:18px 28px;box-shadow:0 2px 10px #4a90e220;display:flex;flex-direction:column;align-items:center;min-width:170px;margin-bottom:18px;'>`
          + `<span style='font-size:1.1rem;color:#357abd;font-weight:600;'>⏳ Horas totales</span>`
          + `<span style='font-size:2.2rem;font-weight:bold;color:#357abd;margin-top:4px;'>${Math.floor(totalMin/60)}h ${totalMin%60}m</span>`
          + `<span style='font-size:1.1rem;color:#43b97b;font-weight:600;margin-top:8px;'>≈ ${totalUSDT} USDT</span>`
        + `</div>`;
        let eliminarBtn = `<button onclick='window.eliminarTodosRegistrosGlobales()' class='btn btn-eliminar'>🗑️ Eliminar todos los registros</button>`;
        let gestionUsuariosHtml = `
          <div style="margin-bottom:18px;">
            <h3>Gestión de usuarios</h3>
            <input id="nuevoUsuario" placeholder="Usuario" style="margin-right:4px;">
            <input id="nuevaClave" placeholder="Clave" type="password" style="margin-right:4px;">
            <select id="nuevoRol" style="margin-right:4px;">
              <option value="usuario">Usuario</option>
              <option value="superadmin">Superadmin</option>
            </select>
            <button onclick="window.agregarUsuario()" class="btn btn-enviar" style="margin-bottom:6px;">Agregar usuario</button>
            <div id="usuariosLista"></div>
          </div>
        `;
        document.getElementById('adminResumen').innerHTML = eliminarBtn + resumenHtml;
        document.getElementById('adminRegistros').innerHTML = '';
        document.getElementById('adminModal').style.display = 'flex';
        poblarSidebarUsuarios(); // <-- Añade esto aquí
      });
    }
    window.eliminarTodosRegistrosGlobales = function() {
      Swal.fire({
        title: '¿Seguro?',
        text: '¿Seguro que deseas eliminar TODOS los registros?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref('registros').remove();
          document.getElementById('adminModal').style.display = 'none';
          Swal.fire('Eliminado', 'Todos los registros han sido eliminados.', 'success');
        }
      });
    }
    window.agregarUsuario = function() {
      const usuario = document.getElementById('nuevoUsuario').value.trim().toLowerCase();
      const clave = document.getElementById('nuevaClave').value.trim();
      const rol = document.getElementById('nuevoRol').value;
      if (!usuario || !clave) {
        Swal.fire('Campos requeridos', 'Usuario y clave requeridos', 'warning');
        return;
      }
      db.ref('usuarios/' + usuario).set({ usuario, clave, rol }, err => {
        if (err) {
          Swal.fire('Error', 'Error al agregar usuario', 'error');
          return;
        }
        document.getElementById('nuevoUsuario').value = '';
        document.getElementById('nuevaClave').value = '';
        mostrarListaUsuarios();
        Swal.fire('¡Listo!', 'Usuario agregado', 'success');
      });
    };
    // Modifica mostrarListaUsuarios para actualizar en tiempo real el estado de conexión
    function mostrarListaUsuarios() {
      // Usar 'on' para escuchar cambios en tiempo real
      db.ref('usuarios').on('value', snap => {
        const data = snap.val() || {};
        let html = '<ul style="list-style:none;padding:0;">';
        Object.entries(data).forEach(([u, info]) => {
          const conectado = info.conectado ? '#43b97b' : '#bbb';
          html += `<li style="margin-bottom:8px;display:flex;align-items:center;">
            <span style="display:inline-block;width:11px;height:11px;border-radius:50%;background:${conectado};margin-right:7px;border:1px solid #ccc;"></span>
            <span style="font-weight:600;">${u}</span>
            <span style="font-size:12px;color:#888;margin-left:6px;">(${info.rol})</span>
            <button onclick="window.eliminarUsuario('${u}')" class="btn btn-eliminar" style="padding:2px 8px;font-size:13px;margin-left:auto;">Eliminar</button>
            <button onclick="window.resetClaveUsuario('${u}')" class="btn btn-contingencia" style="padding:2px 8px;font-size:13px;margin-left:6px;">Reset clave</button>
          </li>`;
        });
        html += '</ul>';
        document.getElementById('usuariosLista').innerHTML = html;
        // Actualiza también en la barra lateral del panel admin
        document.getElementById('usuariosSidebarLista').innerHTML = html;
      });
    }
    window.eliminarUsuario = function(usuario) {
      Swal.fire({
        title: '¿Eliminar usuario?',
        text: '¿Eliminar usuario ' + usuario + '?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref('usuarios/' + usuario).remove(err => {
            if (err) {
              Swal.fire('Error', 'Error al eliminar', 'error');
              return;
            }
            mostrarListaUsuarios();
            Swal.fire('Eliminado', 'Usuario eliminado', 'success');
          });
        }
      });
    };
    window.resetClaveUsuario = function(usuario) {
  Swal.fire({
    title: 'Resetear clave',
    text: `¿Seguro que deseas resetear la clave del usuario "${usuario}" a "123"?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, resetear',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      db.ref('usuarios/' + usuario + '/clave').set('123', err => {
        if (err) {
          Swal.fire('Error', 'No se pudo resetear la clave.', 'error');
        } else {
          Swal.fire('¡Listo!', 'Clave reseteada a "123".', 'success');
        }
      });
    }
  });
};

    // --- Inicialización y restauración de estado ---
    window.addEventListener('DOMContentLoaded', () => {
      // Restaurar inicio pendiente
      const inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) {
        try {
          const data = JSON.parse(inicioPend);
          if (data && data.inicio) {
            inicio = new Date(data.inicio);
            document.getElementById("nombre").value = data.nombre || '';
            document.getElementById("motivo").value = data.motivo || '';
            document.getElementById("horaInicio").textContent = formatearHora(inicio);
            document.getElementById("horaFin").textContent = "-";
            document.getElementById("duracion").textContent = "-";
          }
        } catch(e) {}
      }
      aplicarModoOscuro();
      // Mostrar login al cargar
      mostrarLogin();
      setAdminBtnByRol(null);
      // Eliminar historial local y remoto
      window.eliminarHistorial = function() {
        if (confirm('¿Seguro que deseas eliminar tu historial?')) {
          const usuario = usuarioActual || document.getElementById('nombre').value.trim().toLowerCase();
          db.ref('registros').once('value', snapshot => {
            const data = snapshot.val() || {};
            // Elimina solo los registros del usuario actual
            Object.entries(data).forEach(([key, registro]) => {
              if (registro.nombre && registro.nombre.toLowerCase() === usuario) {
                db.ref('registros/' + key).remove();
              }
            });
            document.getElementById('historial').innerHTML = "<strong>Histórico de tiempos:</strong><div id='resumenHoras'></div>";
            Swal.fire('Eliminado', 'Tu historial ha sido eliminado.', 'success');
          });
          localStorage.removeItem('historial_registros');
        }
      };
    });
    document.getElementById('btnCambiarClave').onclick = async function() {
  const { value: formValues } = await Swal.fire({
    title: 'Cambiar clave',
    html:
      '<input id="swal-usuario" class="swal2-input" placeholder="Usuario">' +
      '<input id="swal-clave-actual" type="password" class="swal2-input" placeholder="Clave actual">' +
      '<input id="swal-nueva-clave" type="password" class="swal2-input" placeholder="Nueva clave">',
    focusConfirm: false,
    preConfirm: () => {
      return [
        document.getElementById('swal-usuario').value.trim().toLowerCase(),
        document.getElementById('swal-clave-actual').value.trim(),
        document.getElementById('swal-nueva-clave').value.trim()
      ];
    },
    confirmButtonText: 'Guardar',
    showCancelButton: true,
    cancelButtonText: 'Cancelar'
  });

  if (!formValues) return; // Cancelado

  const [usuario, claveActual, nuevaClave] = formValues;
  if (!usuario || !claveActual || !nuevaClave) {
    Swal.fire('Campos requeridos', 'Completa todos los campos.', 'warning');
    return;
  }

  db.ref('usuarios/' + usuario).once('value', snap => {
    const data = snap.val();
    if (!data) {
      Swal.fire('Error', 'Usuario no encontrado.', 'error');
      return;
    }
    if (data.clave !== claveActual) {
      Swal.fire('Error', 'La clave actual es incorrecta.', 'error');
      return;
    }
    db.ref('usuarios/' + usuario + '/clave').set(nuevaClave, err => {
      if (err) {
        Swal.fire('Error', 'No se pudo cambiar la clave.', 'error');
        return;
      }
      Swal.fire('¡Listo!', 'Clave cambiada correctamente.', 'success');
    });
  });
};
  </script>

  <div class="container">
    <div class="card">
      <h1>Contabilizador de Horas</h1>
      <div class="nombre-container">
        <input type="text" id="nombre" name="nombre" placeholder="Tu nombre">
        <input type="text" id="motivo" name="motivo" placeholder="Motivo">
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <input type="text" id="motivoTrabajo" name="motivoTrabajo" placeholder="Motivo del trabajo (EO)" style="width:165px;">
          <input type="number" id="montoPagar" name="montoPagar" placeholder="Monto a pagar" style="width:107px;height:40px;" min="0" step="any">
          <button onclick="agregarMotivoTrabajo()" class="btn" style="width:182px;white-space:nowrap;text-align:center;">Añadir al historial</button>
        </div>
        <button id="contingenciaBtn" class="btn btn-contingencia" style="margin-top:8px;margin-bottom:8px;">Sumar 10 USDT por contingencia</button>
      </div>
      <button onclick="marcarInicio()" class="btn">Marcar Inicio</button>
      <button onclick="marcarFin()" class="btn">Marcar Fin</button>
      <button onclick="eliminarHistorial()" class="btn btn-eliminar">Eliminar Historial</button>
      <div class="info">
        <p><strong>Hora de inicio:</strong> <span id="horaInicio">-</span></p>
        <p><strong>Hora de fin:</strong> <span id="horaFin">-</span></p>
        <p><strong>Duración:</strong> <span id="duracion">-</span></p>
      </div>
      <div class="historial" id="historial">
        <strong>Histórico de tiempos:</strong>
        <div id="resumenHoras"></div>
      </div>
    </div>
  </div>
  <button id="darkModeToggle" class="btn-darkmode" title="Alternar modo oscuro/claro">🌙</button>
  <button id="adminBtn" class="btn-admin" title="Administrador">🔑</button>
  <div id="adminModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:400;align-items:center;justify-content:center;">
  <div style="background:#fff;color:#23272e;display:flex;flex-direction:row;padding:0;border-radius:16px;max-width:900px;width:95vw;max-height:90vh;overflow:hidden;position:relative;">
    <!-- Panel lateral de usuarios -->
    <div id="adminSidebar" style="width:270px;background:#f7fafd;border-radius:16px 0 0 16px;padding:28px 12px 24px 18px;box-shadow:2px 0 12px #4a90e210;overflow-y:auto;">
      <h3 style="margin-top:0;font-size:1.1rem;color:#357abd;">Usuarios</h3>
      <div id="usuariosSidebarLista"></div>
      <div style="margin-top:18px;">
        <input id="nuevoUsuario" placeholder="Usuario" style="margin-bottom:6px;width:90%;">
        <input id="nuevaClave" placeholder="Clave" type="password" style="margin-bottom:6px;width:90%;">
        <select id="nuevoRol" style="margin-bottom:6px;width:90%;">
          <option value="usuario">Usuario</option>
          <option value="superadmin">Superadmin</option>
        </select>
        <button onclick="window.agregarUsuario()" class="btn btn-enviar" style="width:90%;">Agregar usuario</button>
      </div>
    </div>
    <!-- Panel principal admin -->
    <div style="flex:1;padding:32px 24px 24px 24px;overflow-y:auto;position:relative;">
      <button id="closeAdminModal" style="position:absolute;top:12px;right:16px;font-size:22px;background:none;border:none;cursor:pointer;color:#888;">✖️</button>
      <h2 style="margin-top:0">Panel de Administración</h2>
      <div id="adminResumen"></div>
      <div id="adminRegistros" style="margin-top:18px;"></div>
      <div style="display: flex; justify-content: center; margin-top: 18px;">
        <button id="descargarExcelAdminBtn" class="btn" style="width: 60%; min-width: 220px;">Descargar todos los registros (Excel)</button>
      </div>
    </div>
  </div>
</div>

  <!-- Modal de Login Mejorado -->
  <div id="loginModal" style="display:flex;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;align-items:center;justify-content:center;background:rgba(30,40,60,0.85);backdrop-filter:blur(2px);">
    <div style="background:linear-gradient(120deg,#fff 80%,#e3e8ee 100%);padding:38px 28px 28px 28px;border-radius:22px;max-width:350px;width:min(350px,95vw);box-shadow:0 8px 32px #357abd33;display:flex;flex-direction:column;align-items:center;position:relative;">
      <div style="background:linear-gradient(135deg,#4A90E2 60%,#43b97b 100%);width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:18px;box-shadow:0 2px 12px #4a90e240;">
        <span style="font-size:2.2rem;color:#fff;">🔒</span>
      </div>
      <h2 style="margin:0 0 18px 0;font-size:1.5rem;color:#357abd;font-weight:700;letter-spacing:0.5px;">Iniciar sesión</h2>
      <div style="width:100%;margin-bottom:12px;display:flex;justify-content:center;">
        <div style="position:relative;width:100%;">
          <span style="position:absolute;left:12px;top:35%;transform:translateY(-50%);font-size:1.1rem;color:#43b97b;pointer-events:none;">👤</span>
          <input type="text" id="loginUsuario" placeholder="Usuario" style="width:100%;padding:12px 12px 12px 38px;font-size:16px;border:1.5px solid #43b97b;border-radius:8px;margin-bottom:10px;background:#f7fafd;transition:border 0.3s;box-sizing:border-box;">
        </div>
      </div>
      <div style="width:100%;margin-bottom:18px;display:flex;justify-content:center;">
        <div style="position:relative;width:100%;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1.1rem;color:#357abd;pointer-events:none;">🔑</span>
          <input type="password" id="loginClave" placeholder="Clave" style="width:100%;padding:12px 12px 12px 38px;font-size:16px;border:1.5px solid #357abd;border-radius:8px;margin-bottom:0;background:#f7fafd;transition:border 0.3s;box-sizing:border-box;">
        </div>
      </div>
      <button id="loginBtn" class="btn" style="width:100%;font-size:1.1rem;padding:12px 0 12px 0;border-radius:8px;box-shadow:0 2px 8px #4a90e220;">Entrar</button>
      <button id="btnCambiarClave" class="btn btn-cambiar-clave">Cambiar mi clave</button>
      <div id="loginError" style="color:#e74c3c;margin-top:14px;display:none;font-size:1rem;text-align:center;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    // Descargar todos los registros y el monto total en USDT desde el panel admin
    document.getElementById('descargarExcelAdminBtn').onclick = function() {
      db.ref('registros').once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registros = Object.values(data);
        if (registros.length === 0) {
          Swal.fire('Sin datos', 'No hay registros para exportar.', 'info');
          return;
        }
        // Prepara los datos para Excel
        let totalMin = 0, totalMontos = 0;
        const rows = registros.map(r => {
          let min = 0;
          if (r.duracion) {
            const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
            if (match) min = parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
          }
          totalMin += min;
          let montoExcel = '';
          if (r.monto && !isNaN(r.monto)) {
            totalMontos += parseFloat(r.monto);
            montoExcel = parseFloat(r.monto).toFixed(2);
          }
          return {
            Nombre: r.nombre || '',
            Motivo: r.motivo || '',
            'Monto (USDT)': montoExcel,
            Día: r.dia || '',
            Inicio: r.inicio || '',
            Fin: r.fin || '',
            Duración: r.duracion || ''
          };
        });
        // Agrega una fila de total al final
        const totalUSDTExcel = (totalMin * 0.025 + totalMontos).toFixed(2);
        rows.push({
          Nombre: '',
          Motivo: '',
          'Monto (USDT)': '',
          Día: '',
          Inicio: '',
          Fin: 'TOTAL USDT',
          Duración: totalUSDTExcel
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Registros");
        XLSX.writeFile(wb, "registros_completos.xlsx");
      }); // <-- este paréntesis y punto y coma cierran la función correctamente
    };
  </script>
  <style>
    .swal2-container {
      z-index: 10001 !important;
    }
  </style>
</body>
</html>
