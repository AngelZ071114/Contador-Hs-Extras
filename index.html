<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contabilizador de Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Librer√≠as externas -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Tus estilos aqu√≠ (no modificados, ya est√°n optimizados y bien estructurados) -->
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8; color: #23272e;
      transition: background 0.5s, color 0.5s;
    }
    .container {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      margin-top: 15vh; /* <-- mueve la card 15% hacia abajo */
      text-align: center;
      padding: 0 10px;
    }
    .card {
      background: white; padding: 30px 40px; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; width: 100%;
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
    .nombre-container { margin-bottom: 20px; }
    input[type="text"], input[type="number"] {
      padding: 10px; width: 100%; font-size: 16px;
      border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px;
      background: #fff; color: #23272e; transition: background 0.3s, border 0.3s, color 0.3s;
      box-sizing: border-box;
    }
    .btn {
      background: linear-gradient(90deg, #4A90E2 60%, #357ABD 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      margin: 10px 5px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #4a90e220;
      outline: none;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s, transform 0.2s;
      letter-spacing: 0.5px;
    }
    .btn:hover {
      background: linear-gradient(90deg, #357ABD 60%, #4A90E2 100%);
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #4a90e240;
    }
    .btn-contingencia {
      background: linear-gradient(90deg, #f7b731 60%, #f97f51 100%) !important;
      color: #23272e !important;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 8px #f7b73140;
    }
    .btn-contingencia:hover {
      background: linear-gradient(90deg, #f97f51 60%, #f7b731 100%) !important;
      color: #23272e !important;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #f7b73160;
    }
    body.manual-dark .btn-contingencia {
      background: linear-gradient(90deg, #f7b731 60%, #f97f51 100%) !important;
      color: #23272e !important;
      box-shadow: 0 2px 8px #ff767533;
    }
    body.manual-dark .btn-contingencia:hover {
      background: linear-gradient(90deg, #f97f51 60%, #f7b731 100%) !important;
      color: #23272e !important;
      box-shadow: 0 4px 16px #ff767555;
    }
    .btn-admin {
      background: linear-gradient(135deg, #4A90E2 60%, #43b97b 100%);
      color: #fff;
      position:fixed;bottom:24px;right:24px;z-index:300;
      font-size:22px;
      padding: 13px;
      border-radius: 50%;
      border:none;
      box-shadow:0 2px 8px #4a90e220;cursor:pointer;
      transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-admin:hover {
      background: linear-gradient(135deg, #43b97b 60%, #4A90E2 100%);
      transform: scale(1.08);
      box-shadow: 0 4px 16px #43b97b40;
    }
    .btn-darkmode {
      position:fixed;top:18px;right:24px;z-index:200;
      font-size:22px;
      padding: 13px;
      border-radius: 50%;
      border:none;
      box-shadow:0 2px 8px #0002;
      cursor:pointer;
      background: linear-gradient(135deg, #fff 60%, #e0e6ef 100%);
      color: #23272e;
      transition: background 0.4s, color 0.4s, box-shadow 0.3s, transform 0.2s;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-darkmode:hover {
      background: linear-gradient(135deg, #e0e6ef 60%, #fff 100%);
      color: #357abd;
      transform: scale(1.08);
      box-shadow: 0 4px 16px #4a90e220;
    }
    .btn-eliminar {
      background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px #e74c3c40 !important;
      border: none !important;
      margin: 10px 5px !important;
    }
    .btn-eliminar:hover {
      background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
      color: #fff !important;
      transform: translateY(-2px) scale(1.04) !important;
      box-shadow: 0 4px 16px #e74c3c60 !important;
    }
    /* Bot√≥n especial para cambiar clave - amarillo auyama s√≥lido */
    .btn-cambiar-clave {
      background: #e1a700 !important; /* amarillo auyama */
      color: #23272e !important;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 8px #e1a70033;
      margin-top: 8px;
      width: 100%;
      font-size: 1.1rem;
      padding: 12px 0 12px 0;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
    }
    .btn-cambiar-clave:hover {
      background: #b8860b !important; /* un poco m√°s oscuro al pasar el mouse */
      color: #fffbe6 !important;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #e1a70055;
    }

    /* Modo oscuro para el bot√≥n cambiar clave */
    body.manual-dark .btn-cambiar-clave {
      background: #e6a503 !important; /* amarillo auyama oscuro */
      color: #fffbe6 !important;
      box-shadow: 0 2px 8px #b8860b55;
    }
    body.manual-dark .btn-cambiar-clave:hover {
      background: #e1a700 !important;
      color: #23272e !important;
      box-shadow: 0 4px 16px #ffc00177;
    }
    body.manual-dark .btn,
    body.manual-dark .btn-contingencia,
    body.manual-dark .btn-admin,
    body.manual-dark .btn-darkmode,
    body.manual-dark .btn-eliminar,
    body.manual-dark .btn-enviar {
      filter: none !important;
      opacity: 1 !important;
      color: inherit;
    }
    body.manual-dark .btn-eliminar {
    background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
    color: #fff !important;
    border: none !important;
    }
    body.manual-dark .btn-eliminar:hover {
    background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
    color: #fff !important;
    }
    .info p { font-size: 16px; color: #555; margin: 10px 0; }
    .info span { font-weight: bold; color: #222; }
    .historial {
      max-width: 550px;
      min-width: 320px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      margin-top: 30px;
      text-align: left;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      overflow-y: auto;
    }
    .historial-item {
      font-size: 15px;
      margin-bottom: 18px;
      background: linear-gradient(120deg, #f7fafd 80%, #e3e8ee 100%);
      padding: 16px 20px 12px 20px;
      border-radius: 14px;
      color: #23272e;
      box-shadow: 0 4px 18px #4a90e220;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
      width: 85%;              /* <-- Nuevo: 15% m√°s angosto */
      margin-left: auto;       /* Centrado horizontal */
      margin-right: auto;      /* Centrado horizontal */
    }
    .historial-item strong { color: #357abd; font-size: 17px; font-weight: 700; margin-right: 6px; }
    .historial-item .historial-motivo { color: #f97f51; font-weight: 600; font-size: 15px; margin-left: 2px; }
    .historial-item .historial-monto { color: #43b97b; font-weight: 600; font-size: 15px; margin-left: 2px; }
    .historial-item .historial-fecha { color: #888; font-size: 13px; margin-top: 2px; display: block; }
    .historial-item .historial-extra { color: #357abd; font-size: 14px; margin-top: 2px; display: block; }
    body.manual-dark { background: #181c20 !important; color: #e0e6ef !important; }
    .manual-dark .card { background: #23272e !important; color: #e0e6ef !important; box-shadow: 0 10px 25px rgba(0,0,0,0.25) !important; }
    .manual-dark input[type="text"], .manual-dark input[type="number"] { background: #2c3e50 !important; color: #eaf6fb !important; border: 1.5px solid #4a90e2 !important; }
    .manual-dark input[type="text"]::placeholder, .manual-dark input[type="number"]::placeholder { color: #b3c6e0 !important; opacity: 0.8; }
    .manual-dark .btn { background: #3b6cb7 !important; color: #fff !important; }
    .manual-dark .btn:hover { background: #5fa8d3 !important; }
    .manual-dark .btn-contingencia { background: linear-gradient(90deg, #f7b731 60%, #f97f51 100%) !important; color: #23272e !important; }
    .manual-dark .info p { color: #b3c6e0 !important; }
    .manual-dark .info span { color: #e0e6ef !important; }
    .manual-dark .historial { border-top: 1px solid #3b4a5a !important; }
    .manual-dark .historial-item { background: #23272e !important; color: #e0e6ef !important; box-shadow: 0 1px 6px #0004 !important; }
    .manual-dark .historial-item strong { color: #43e97b !important; }
    .manual-dark .historial-item .historial-motivo { color: #f7b731 !important; }
    .manual-dark .historial-item .historial-monto { color: #43e97b !important; }
    .manual-dark .historial-item .historial-fecha { color: #b3c6e0 !important; }
    .manual-dark h1 { color: #e0e6ef !important; }
    #darkModeToggle { transition: background 0.4s, color 0.4s; }

    /* Animaci√≥n para el modal de login */
    #loginModal > div {
      animation: loginPop 0.6s cubic-bezier(.23,1.12,.56,1.01);
    }
    @keyframes loginPop {
      0% { transform: scale(0.7) translateY(40px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* --- Panel administrativo modo oscuro: gama mejorada y detalles visuales --- */
body.manual-dark #adminModal,
body.manual-dark #adminModal.manual-dark {
  background: rgba(18, 22, 34, 0.98) !important;
  backdrop-filter: blur(3px);
}
body.manual-dark #adminModal > div,
body.manual-dark #adminPanel {
  background: linear-gradient(120deg, #23283a 70%, #1e2233 100%) !important;
  color: #e3eafc !important;
  border-radius: 18px !important;
  box-shadow: 0 8px 32px #000b !important;
  border: 1.5px solid #27304a !important;
  padding: 32px 24px 24px 24px !important;
  max-width: 700px;
  width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
body.manual-dark #adminModal h2, 
body.manual-dark #adminModal h3 {
  color: #7fd7ff !important;
  letter-spacing: 0.5px;
  margin-bottom: 14px;
}
body.manual-dark #adminModal input, 
body.manual-dark #adminModal select {
  background: #232c3d !important;
  color: #e3eafc !important;
  border: 1.5px solid #3b4a6b !important;
  border-radius: 7px !important;
  padding: 8px 10px !important;
  margin-bottom: 6px;
}
body.manual-dark #adminModal input::placeholder {
  color: #8fa2c7 !important;
  opacity: 0.8;
}
body.manual-dark #adminModal table {
  background: #23283a !important;
  color: #e3eafc !important;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px #1e233340;
  margin-bottom: 18px;
}
body.manual-dark #adminModal th {
  background: #27304a !important;
  color: #7fd7ff !important;
  border: 1px solid #3b4a6b !important;
  font-weight: 600;
  padding: 10px 8px;
}
body.manual-dark #adminModal td {
  background: #23283a !important;
  color: #e3eafc !important;
  border: 1px solid #27304a !important;
  padding: 9px 8px;
}
body.manual-dark #adminModal tr:nth-child(even) td {
  background: #232c3d !important;
}
body.manual-dark #adminModal tr:hover td {
  background: #2e3650 !important;
  color: #fff !important;
  transition: background 0.2s, color 0.2s;
}
body.manual-dark #adminModal .btn,
body.manual-dark #adminModal .btn-enviar {
  background: linear-gradient(90deg, #3b4a6b 60%, #1e2a3a 100%) !important;
  color: #7fd7ff !important;
  border: none !important;
  box-shadow: 0 2px 8px #7fd7ff22 !important;
  font-weight: bold;
  border-radius: 7px !important;
}
body.manual-dark #adminModal .btn:hover,
body.manual-dark #adminModal .btn-enviar:hover {
  background: linear-gradient(90deg, #1e2a3a 60%, #3b4a6b 100%) !important;
  color: #fff !important;
  box-shadow: 0 4px 16px #7fd7ff44 !important;
}
body.manual-dark #adminModal .btn-eliminar {
  background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #e74c3c40 !important;
}
body.manual-dark #adminModal .btn-eliminar:hover {
  background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
  color: #fff !important;
  box-shadow: 0 4px 16px #e74c3c60 !important;
}
body.manual-dark #adminModal .btn-contingencia {
  background: linear-gradient(90deg, #ffe082 60%, #ffb74d 100%) !important;
  color: #23272e !important;
  box-shadow: 0 2px 8px #ffe08240 !important;
}
body.manual-dark #adminModal .btn-contingencia:hover {
  background: linear-gradient(90deg, #ffb74d 60%, #ffe082 100%) !important;
  color: #23272e !important;
  box-shadow: 0 4px 16px #ffe08260 !important;
}
body.manual-dark #adminModal ul {
  background: none !important;
  padding: 0;
}
body.manual-dark #adminModal li {
  background: #232c3d !important;
  color: #e3eafc !important;
  border-radius: 7px;
  margin-bottom: 6px;
  padding: 6px 10px;
  display: flex;
  align-items: center;
  box-shadow: 0 1px 4px #0002;
}
body.manual-dark #adminModal li b {
  color: #7fd7ff !important;
}
body.manual-dark #adminModal select {
  background: #232c3d !important;
  color: #7fd7ff !important;
  border: 1.5px solid #3b4a6b !important;
}
body.manual-dark #adminModal #usuariosLista button {
  margin-left: 6px;
}
body.manual-dark #adminModal #closeAdminModal {
  color: #7fd7ff !important;
  background: none !important;
  border-radius: 50% !important;
  transition: background 0.2s, color 0.2s;
}
body.manual-dark #adminModal #closeAdminModal:hover {
  color: #fff !important;
  background: #2e3650 !important;
}
body.manual-dark #adminModal div[style*="background:#f7fafd"] {
  background: #27304a !important;
  color: #7fd7ff !important;
  box-shadow: 0 2px 10px #7fd7ff22 !important;
}
body.manual-dark #adminModal span[style*="color:#357abd"] {
  color: #7fd7ff !important;
}
body.manual-dark #adminModal span[style*="color:#43b97b"] {
  color: #43e97b !important;
}
body.manual-dark #calculoTiempoPanel {
  background: linear-gradient(120deg, #23283a 70%, #1e2233 100%) !important;
  color: #e3eafc !important;
  border-radius: 18px !important;
  box-shadow: 0 8px 32px #000b !important;
  border: 1.5px solid #27304a !important;
  padding: 32px 24px 24px 24px !important;
  max-width: 700px;
  width: 95vw;
  max-height: 90vh;
  overflow: hidden;
  position: relative;
}
body.manual-dark #calculoTiempoPanel input,
body.manual-dark #calculoTiempoPanel select {
  background: #232c3d !important;
  color: #e3eafc !important;
  border: 1.5px solid #3b4a6b !important;
  border-radius: 7px !important;
  padding: 8px 10px !important;
  margin-bottom: 6px;
}
body.manual-dark #calculoTiempoPanel input::placeholder {
  color: #8fa2c7 !important;
  opacity: 0.8;
}
body.manual-dark #calculoTiempoPanel button {
  background: linear-gradient(90deg, #3b4a6b 60%, #1e2a3a 100%) !important;
  color: #7fd7ff !important;
  border: none !important;
  box-shadow: 0 2px 8px #7fd7ff22 !important;
  font-weight: bold;
  border-radius: 7px !important;
}
body.manual-dark #calculoTiempoPanel button:hover {
  background: linear-gradient(90deg, #1e2a3a 60%, #3b4a6b 100%) !important;
  color: #fff !important;
  box-shadow: 0 4px 16px #7fd7ff44 !important;
}

/* Bot√≥n verde para Marcar Inicio */
.btn-inicio {
  background: linear-gradient(90deg, #43b97b 60%, #2ecc71 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #43b97b40 !important;
  border: none !important;
  margin: 10px 5px !important;
}
.btn-inicio:hover {
  background: linear-gradient(90deg, #2ecc71 60%, #43b97b 100%) !important;
  color: #fff !important;
  transform: translateY(-2px) scale(1.04) !important;
  box-shadow: 0 4px 16px #43b97b60 !important;
}

/* Bot√≥n rojo para Marcar Fin */
.btn-fin {
  background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #e74c3c40 !important;
  border: none !important;
  margin: 10px 5px !important;
}
.btn-fin:hover {
  background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%) !important;
  color: #fff !important;
  transform: translateY(-2px) scale(1.04) !important;
  box-shadow: 0 4px 16px #e74c3c60 !important;
}

/* Modo oscuro: mismos colores, pero sin perder contraste */
body.manual-dark .btn-inicio {
  background: linear-gradient(90deg, #43e97b 60%, #2ecc71 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #43e97b33 !important;
}
body.manual-dark .btn-inicio:hover {
  background: linear-gradient(90deg, #2ecc71 60%, #43e97b 100%) !important;
  color: #23272e !important;
  box-shadow: 0 4px 16px #43e97b55 !important;
}
body.manual-dark .btn-fin {
  background: linear-gradient(90deg, #ff7675 60%, #e74c3c 100%) !important;
  color: #fff !important;
  box-shadow: 0 2px 8px #ff767533 !important;
}
body.manual-dark .btn-fin:hover {
  background: linear-gradient(90deg, #e74c3c 60%, #ff7675 100%) !important;
  color: #23272e !important;
  box-shadow: 0 4px 16px #ff767555 !important;
}
  </style>
</head>
<body>
  <!-- Panel de login, panel admin, modal calcular tiempo, botones, etc. -->
  <div class="container">
    <div class="card">
      <h1>Contador de Horas</h1>
      <div id="saludoUsuario" style="display:none; font-size:1.1rem; font-weight:bold; margin-bottom:10px;"></div>
      <input type="text" id="nombre" name="nombre" placeholder="Tu nombre">
      <input type="text" id="motivo" name="motivo" placeholder="Motivo">
      <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
        <input type="text" id="motivoTrabajo" name="motivoTrabajo" placeholder="Motivo del trabajo (EO)" style="width:165px;">
        <input type="number" id="montoPagar" name="montoPagar" placeholder="Monto a pagar" style="width:107px;height:40px;" min="0" step="any">
        <button onclick="agregarMotivoTrabajo()" class="btn" style="width:200px;height:40px; white-space:nowrap;text-align:center; transform: translateY(-15%);">A√±adir al historial</button>
      </div>
      <button id="contingenciaBtn" class="btn btn-contingencia" style="margin-top:8px;margin-bottom:8px;">Sumar 10 USDT por contingencia</button>
    </div>
    <button onclick="marcarInicio()" class="btn btn-inicio">Marcar Inicio</button>
    <button onclick="marcarFin()" class="btn btn-fin">Marcar Fin</button>
    <div class="info">
      <p><strong>Hora de inicio:</strong> <span id="horaInicio">-</span></p>
      <p><strong>Hora de fin:</strong> <span id="horaFin">-</span></p>
      <p><strong>Duraci√≥n:</strong> <span id="duracion">-</span></p>
    </div>
    <div class="historial" id="historial">
      <strong>Hist√≥rico de tiempos:</strong>
      <div id="resumenHoras"></div>
    </div>
  </div>
  <!-- Bot√≥n de alternar modo oscuro/claro y cerrar sesi√≥n, juntos en la esquina superior derecha -->
<div style="position:fixed;top:1.5%;right:24px;z-index:201;display:flex;gap:10px;">
  <button id="darkModeToggle" class="btn-darkmode" title="Alternar modo oscuro/claro">üåô</button>
  <button id="logoutBtn" class="btn" style="background:linear-gradient(90deg,#888 60%,#555 100%);padding:12px 22px;font-size:16px;border-radius:8px;min-width:120px;position:relative;right:35%;" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
</div>
  <button id="adminBtn" class="btn-admin" title="Administrador">üîë</button>
  <!-- Panel administrativo optimizado -->
  <div id="adminModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:400;align-items:center;justify-content:center;">
    <div style="background:#fff;color:#23272e;display:flex;flex-direction:row;padding:0;border-radius:16px;max-width:1100px;width:95vw;max-height:90vh;overflow:hidden;position:relative;">
      <!-- Panel lateral de usuarios (m√°s ancho) -->
      <div id="adminSidebar" style="width:370px;background:#f7fafd;border-radius:16px 0 0 16px;padding:28px 18px 24px 24px;box-shadow:2px 0 12px #4a90e210;overflow-y:auto;">
        <h3 style="margin-top:0;font-size:1.1rem;color:#357abd;">Operadores</h3>
        <div id="usuariosSidebarLista"></div>
      </div>
      <!-- Panel principal admin -->
      <div style="flex:1;padding:32px 24px 24px 24px;overflow-y:auto;position:relative;">
        <button id="closeAdminModal" style="position:absolute;top:12px;right:16px;font-size:22px;background:none;border:none;cursor:pointer;color:#888;">‚úñÔ∏è</button>
        <h2 style="margin-top:0">Panel de Administraci√≥n</h2>
        <!-- Gesti√≥n de usuarios en una fila, sin input de clave -->
        <div id="gestionUsuarios" style="margin-bottom:24px; display:flex; align-items:flex-end; gap:10px;">
          <div style="display:flex; flex-direction:column;">
            <label for="nuevoUsuario" style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Usuario</label>
            <input id="nuevoUsuario" placeholder="Usuario" style="width:140px;">
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="nuevoRol" style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Rol</label>
            <select id="nuevoRol" style="width:120px;">
              <option value="usuario">Usuario</option>
              <option value="superadmin">Superadmin</option>
            </select>
          </div>
          <button onclick="window.agregarUsuario()" class="btn btn-agregar-usuario" style="width:170px;white-space:nowrap; transform: translateY(16%) translateX(-10%) scale(0.80);">Agregar usuario</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:18px;">
          <button id="btnMostrarCalculoTiempoAdmin" class="btn" style="background:linear-gradient(90deg,#6C3483 60%,#43b97b 100%);">Calcular tiempo</button>
        </div>
        <div id="adminResumen"></div>
        <div id="adminRegistros" style="margin-top:18px;"></div>
        <div style="display: flex; justify-content: center; margin-top: 18px;">
          <button id="descargarExcelAdminBtn" class="btn btn-excel" style="width: 60%; min-width: 220px;">Descargar todos los registros (Excel)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Login Mejorado -->
  <div id="loginModal" style="display:flex;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;align-items:center;justify-content:center;background:rgba(30,40,60,0.85);backdrop-filter:blur(2px);">
    <div style="background:linear-gradient(120deg,#fff 80%,#e3e8ee 100%);padding:38px 28px 28px 28px;border-radius:22px;max-width:350px;width:min(350px,95vw);box-shadow:0 8px 32px #357abd33;display:flex;flex-direction:column;align-items:center;position:relative;">
      <div style="background:linear-gradient(135deg,#4A90E2 60%,#43b97b 100%);width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:18px;box-shadow:0 2px 12px #4a90e240;">
        <span style="font-size:2.2rem;color:#fff;">üîí</span>
      </div>
      <h2 style="margin:0 0 18px 0;font-size:1.5rem;color:#357abd;font-weight:700;letter-spacing:0.5px;">Iniciar sesi√≥n</h2>
      <div style="width:100%;margin-bottom:12px;display:flex;justify-content:center;">
        <div style="position:relative;width:100%;">
          <span style="position:absolute;left:12px;top:35%;transform:translateY(-50%);font-size:1.1rem;color:#43b97b;pointer-events:none;">üë§</span>
          <input type="text" id="loginUsuario" placeholder="Usuario" style="width:100%;padding:12px 12px 12px 38px;font-size:16px;border:1.5px solid #43b97b;border-radius:8px;margin-bottom:10px;background:#f7fafd;transition:border 0.3s;box-sizing:border-box;">
        </div>
      </div>
      <div style="width:100%;margin-bottom:18px;display:flex;justify-content:center;">
        <div style="position:relative;width:100%;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1.1rem;color:#357abd;pointer-events:none;">üîë</span>
          <input type="password" id="loginClave" placeholder="Clave" style="width:100%;padding:12px 12px 12px 38px;font-size:16px;border:1.5px solid #357abd;border-radius:8px;margin-bottom:0;background:#f7fafd;transition:border 0.3s;box-sizing:border-box;">
        </div>
      </div>
      <button id="loginBtn" class="btn" style="width:100%;font-size:1.1rem;padding:12px 0 12px 0;border-radius:8px;box-shadow:0 2px 8px #4a90e220;">Entrar</button>
      <button id="btnCambiarClave" class="btn btn-cambiar-clave">Cambiar mi clave</button>
      <div id="loginError" style="color:#e74c3c;margin-top:14px;display:none;font-size:1rem;text-align:center;"></div>
    </div>
  </div>

  <!-- Modal Calcular Tiempo Admin (ya optimizado y con estilo consistente) -->
  <div id="calculoTiempoBoxAdmin" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,40,60,0.85); backdrop-filter:blur(2px); z-index:9999; align-items:center; justify-content:center;">
    <!-- Reemplaza SOLO el div interno de #calculoTiempoBoxAdmin por este -->
<div id="calculoTiempoPanel"
  style="flex:1; padding:32px 24px 24px 24px; position:relative; background:#fff; color:#23272e; border-radius:16px; box-shadow:0 8px 32px #357abd33; max-width:500px; width:95vw; display:flex; flex-direction:column; gap:18px; align-items:flex-start;">
  <button id="btnCerrarCalculoTiempoAdmin"
    style="position:absolute;top:12px;right:16px;font-size:22px;background:none;border:none;cursor:pointer;color:#888;">‚úñÔ∏è</button>
  <h2 style="margin-top:0;margin-bottom:18px;font-size:1.5rem;color:#357abd;font-weight:700;">Calcular tiempo (USDT)</h2>
  <div style="width:100%;display:flex;flex-direction:column;gap:6px;">
    <label for="calculoUsuarioAdmin"
      style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Usuario</label>
    <select id="calculoUsuarioAdmin"
      style="width:100%;padding:10px;border:1.5px solid #357abd;border-radius:8px;background:#f7fafd;">
      <option value="">Selecciona usuario</option>
    </select>
  </div>
  <div style="display:flex;gap:12px;width:100%;">
    <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
      <label for="calculoHorasAdmin"
        style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Horas</label>
      <input type="number" id="calculoHorasAdmin" placeholder="Horas" min="0"
        style="width:100%;padding:10px;border:1.5px solid #43b97b;border-radius:8px;background:#f7fafd;">
    </div>
    <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
      <label for="calculoMinutosAdmin"
        style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Minutos</label>
      <input type="number" id="calculoMinutosAdmin" placeholder="Minutos" min="0" max="59"
        style="width:100%;padding:10px;border:1.5px solid #43b97b;border-radius:8px;background:#f7fafd;">
    </div>
  </div>
  <div style="width:100%;display:flex;flex-direction:column;gap:6px;">
    <label for="calculoMotivoAdmin"
      style="font-size:13px;color:#357abd;font-weight:600;margin-bottom:2px;">Motivo</label>
    <input type="text" id="calculoMotivoAdmin" placeholder="Motivo"
      style="width:100%;padding:10px;border:1.5px solid #357abd;border-radius:8px;background:#f7fafd;">
  </div>
  <div id="calculoResultadoAdmin"
    style="font-size:1.2rem; color:#43b97b; font-weight:bold; margin-top:8px; min-height:24px;"></div>
  <button id="btnAgregarCalculoHistorialAdmin" class="btn"
    style="width:100%;padding:12px;font-size:16px;border-radius:8px;background:linear-gradient(90deg,#4A90E2 60%,#357ABD 100%);color:#fff;cursor:pointer;transition:background 0.3s,transform 0.2s;">
    A√±adir al historial
  </button>
</div>
  </div>
  <!-- Sonido de campana -->
  <audio id="sonidoCampana" preload="auto">
  <source src="campana.mp3" type="audio/mpeg">
</audio>

  <script type="module">
    // --- Configuraci√≥n Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDhgZV2UsMn04-z4AgP_cYB5IYfm-P9zZU",
      authDomain: "contador-de-hs-extras.firebaseapp.com",
      databaseURL: "https://contador-de-hs-extras-default-rtdb.firebaseio.com",
      projectId: "contador-de-hs-extras",
      storageBucket: "contador-de-hs-extras.firebasestorage.app",
      messagingSenderId: "965974169282",
      appId: "1:965974169282:web:f94b2ed159a5c1897a4d5b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Utilidades ---
    const $ = id => document.getElementById(id);
    const obtenerHoraLocalVE = (date = new Date()) =>
      new Date(date.toLocaleString("en-US", { timeZone: "America/Caracas" }));
    const formatearHora = date =>
      date.toLocaleTimeString("es-VE", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

    // --- Estado global ---
    let inicio = null, usuarioActual = null, rolActual = null;
    // --- Marcar desconectado al cerrar o recargar la p√°gina ---
window.addEventListener('beforeunload', function () {
  if (usuarioActual) {
    db.ref('usuarios/' + usuarioActual + '/conectado').set(false);
  }
  // Aqu√≠ sigue tu c√≥digo para guardar registro pendiente (ya lo tienes)
  const inicioPend = localStorage.getItem('inicio_pendiente');
  if (inicioPend) {
    try {
      const data = JSON.parse(inicioPend);
      if (data && data.inicio && data.nombre && data.motivo) {
        const inicio = new Date(data.inicio);
        const fin = new Date();
        const finVE = new Date(fin.toLocaleString("en-US", { timeZone: "America/Caracas" }));
        let motivo = data.motivo;
        let monto = 0;
        if (data.contingencia) {
          motivo += (motivo ? ' | ' : '') + 'Contingencia: 10 USDT';
          monto += 10;
        }
        const hoy = finVE;
        const dia = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
        const registro = {
          nombre: data.nombre,
          motivo,
          dia,
          inicio: formatearHora(inicio),
          fin: formatearHora(finVE),
          duracion: calcularDuracionTexto(inicio, finVE)
        };
        if (monto > 0) registro.monto = monto.toFixed(3);
        db.ref('registros').push(registro);
        localStorage.removeItem('inicio_pendiente');
      }
    } catch (err) {}
  }
});

    // --- Login y sesi√≥n ---
    function loginUsuario() {
      const usuario = $('loginUsuario').value.trim().toLowerCase();
      const clave = $('loginClave').value.trim();
      db.ref('usuarios/' + usuario).once('value', snap => {
        const data = snap.val();
        if (data && data.clave === clave) {
          usuarioActual = usuario;
          rolActual = data.rol;
          localStorage.setItem('usuarioActual', usuario);
          $('loginModal').style.display = 'none';
          $('nombre').value = usuario;
          setAdminBtnByRol(rolActual);
          marcarConectado(usuario, true);
          cargarHistorialUsuario();
          $('saludoUsuario').style.display = 'block';
          $('saludoUsuario').textContent = `Hola, ${usuario}, ¬øc√≥mo te preparas para la chamba? üòé`;
          $('nombre').style.display = 'none';
        } else {
          mostrarError('loginError', 'Usuario o clave incorrectos');
        }
      });
    }
    function mostrarError(id, mensaje) {
      const el = $(id);
      el.textContent = mensaje;
      el.style.display = 'block';
    }
    function setAdminBtnByRol(rol) {
      $('adminBtn').style.display = rol === 'superadmin' ? 'flex' : 'none';
    }
    function marcarConectado(usuario, conectado) {
      db.ref('usuarios/' + usuario + '/conectado').set(conectado);
    }

    // --- Modo oscuro ---
    function aplicarModoOscuro() {
      const dark = localStorage.getItem('modo_oscuro') === '1';
      document.body.classList.toggle('manual-dark', dark);
      const btn = $('darkModeToggle');
      btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
      btn.style.background = dark ? '#23272e' : '#fff';
      btn.style.color = dark ? '#e0e6ef' : '#23272e';
    }

    // --- Inicio y Fin de jornada ---
    window.marcarInicio = () => {
      const nombre = $('nombre').value.trim();
      const motivo = $('motivo').value.trim();
      if (!nombre || !motivo) return Swal.fire('Campo requerido', 'Indica el motivo de la chamba.', 'warning');
      inicio = obtenerHoraLocalVE();
      setInfoInicio(inicio);
      localStorage.setItem('inicio_pendiente', JSON.stringify({ nombre, motivo, inicio: inicio.toISOString() }));
      // Iniciar recordatorio autom√°tico
      if (window._recordatorioFin) clearTimeout(window._recordatorioFin);
      window._recordatorioFin = setTimeout(() => {
        const campana = document.getElementById("sonidoCampana");
      if (campana) campana.play().catch(() => {});
        Swal.fire({
          icon: 'info',
          title: '‚è∞ Recordatorio',
          text: '¬øOlvidaste marcar el fin de tu jornada?',
          confirmButtonText: '¬°Voy, gracias!'
        });
      }, 1000 * 60 * 1); // 1 minuto

    };

    window.marcarFin = () => {
      if (window._recordatorioFin) clearTimeout(window._recordatorioFin);
      if (!inicio) return Swal.fire('Atenci√≥n', 'Primero marca la hora de inicio.', 'warning');
      const nombre = $('nombre').value.trim();
      if (!nombre) return Swal.fire('Campo requerido', 'Por favor, ingresa un nombre.', 'warning');
      let motivo = $('motivo').value.trim();
      let monto = 0, contingencia = false;
      const inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) contingencia = !!JSON.parse(inicioPend).contingencia;
      if (contingencia) {
        motivo += (motivo ? ' | ' : '') + 'Contingencia: 10 USDT';
        monto += 10;
      }
      const fin = obtenerHoraLocalVE();
      setInfoFin(fin, inicio);
      const duracionTexto = calcularDuracionTexto(inicio, fin);
      const hoy = obtenerHoraLocalVE();
      const dia = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
      const registro = { nombre, motivo, dia, inicio: formatearHora(inicio), fin: formatearHora(fin), duracion: duracionTexto };
      if (monto > 0) registro.monto = monto.toFixed(3);
      db.ref('registros').push(registro);
      inicio = null;
      localStorage.removeItem('inicio_pendiente');
    };

    function setInfoInicio(inicio) {
      $("horaInicio").textContent = formatearHora(inicio);
      $("horaFin").textContent = "-";
      $("duracion").textContent = "-";
    }
    function setInfoFin(fin, inicio) {
      $("horaFin").textContent = formatearHora(fin);
      $("duracion").textContent = calcularDuracionTexto(inicio, fin);
    }
    function calcularDuracionTexto(inicio, fin) {
      const duracionMs = fin - inicio;
      const segundos = Math.floor(duracionMs / 1000);
      const minutos = Math.floor(segundos / 60);
      const horas = Math.floor(minutos / 60);
      const restoMin = minutos % 60;
      const restoSeg = segundos % 60;
      return `${horas}h ${restoMin}m ${restoSeg}s`;

    }

    // --- Motivo trabajo directo ---
    window.agregarMotivoTrabajo = () => {
      const motivoTrabajo = $("motivoTrabajo").value.trim();
      const montoPagar = $("montoPagar").value.trim();
      const nombre = $("nombre").value.trim();
      if (!motivoTrabajo || !montoPagar || isNaN(montoPagar) || !nombre)
        return Swal.fire('Campo requerido', 'Indica el motivo y monto a pagar.', 'warning');
      const hoy = new Date();
      const fecha = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
      db.ref('registros').push({ nombre, motivo: motivoTrabajo, monto: montoPagar, dia: fecha });
      $("motivoTrabajo").value = "";
      $("montoPagar").value = "";
      Swal.fire('¬°Listo!', 'Motivo de trabajo registrado correctamente.', 'success');
    };

    // --- Contingencia ---
    $("contingenciaBtn").onclick = () => {
      if (!inicio) return Swal.fire('Atenci√≥n', 'Debes iniciar las horas extras.', 'warning');
      const inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) {
        let data = JSON.parse(inicioPend);
        data.contingencia = true;
        localStorage.setItem('inicio_pendiente', JSON.stringify(data));
      }
      Swal.fire('Contingencia', 'La contingencia se sumar√° al siguiente registro cuando marques fin.', 'info');
    };

    // --- Historial y resumen ---
    function mostrarHistorialFirebase(registros) {
      const historial = document.getElementById("historial");
      historial.innerHTML = "<strong>Hist√≥rico de tiempos:</strong><div id='resumenHoras'></div>";
      registros.forEach((registro) => {
        const item = document.createElement("div");
        item.className = "historial-item";
        let fechaDMY = '-';
        if (registro.dia) {
          const [y, m, d] = registro.dia.split('-');
          fechaDMY = `${d}-${m}-${y}`;
        }
        let html = `<strong>üë§</strong> ${registro.nombre}`;
        if (registro.motivo) html += `<span class='historial-motivo'> | ${registro.motivo}</span>`;
        if (registro.monto) html += `<span class='historial-monto'> | ${registro.monto} USDT</span>`;
        html += `<span class='historial-fecha'>üìÖ ${fechaDMY}</span>`;
        if (registro.inicio && registro.fin) html += `<span class='historial-extra'>‚è∞ ${registro.inicio} - ${registro.fin}</span>`;
        if (registro.duracion) html += `<span class='historial-extra'>‚è≥ ${registro.duracion}</span>`;
        item.innerHTML = html;
        historial.appendChild(item);
      });
    }
    function actualizarResumenHorasFirebase(registros) {
      let totalMin = 0, monto = 0;
      registros.forEach(r => {
        if (r.duracion) {
          const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
          if (match) totalMin += parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
        }
        if (r.monto && !isNaN(r.monto)) monto += parseFloat(r.monto);
      });
      // El monto total en USDT es la suma de los montos expl√≠citos m√°s el valor del tiempo trabajado
      const montoTiempo = totalMin * 0.025;
      const montoTotal = monto + montoTiempo;
      const horas = Math.floor(totalMin / 60);
      const mins = totalMin % 60;
      document.getElementById("resumenHoras").textContent =
        `Horas trabajadas: ${horas}h ${mins}m (Total: ${montoTotal.toFixed(3)} USDT)`;
    }
    function cargarHistorialUsuario() {
      const usuario = usuarioActual || getInputValue('nombre').toLowerCase();
      db.ref('registros').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registrosFirebase = Object.values(data);
        const registrosUsuario = registrosFirebase.filter(r => r.nombre && r.nombre.toLowerCase() === usuario);
        mostrarHistorialFirebase(registrosUsuario);
        actualizarResumenHorasFirebase(registrosUsuario);
      });
    }

    // --- Panel admin y gesti√≥n de usuarios ---
    $("adminBtn").onclick = () => rolActual === 'superadmin' && mostrarPanelAdmin();
    $("closeAdminModal").onclick = () => $("adminModal").style.display = 'none';

    function poblarSidebarUsuarios() {
      db.ref('usuarios').on('value', snap => {
        const data = snap.val() || {};
        let html = '<ul style="list-style:none;padding:0;margin:0;">';
        Object.entries(data).forEach(([u, info]) => {
          const conectado = info.conectado ? '#43b97b' : '#bbb';
          html += `<li style="margin-bottom:8px;display:flex;align-items:center;">
            <span style="display:inline-block;width:11px;height:11px;border-radius:50%;background:${conectado};margin-right:7px;border:1px solid #ccc;"></span>
            <span style="font-weight:600;">${u}</span>
            <span style="font-size:12px;color:#888;margin-left:6px;">(${info.rol})</span>
            <button onclick="window.eliminarUsuario('${u}')" class="btn btn-eliminar" style="padding:2px 8px;font-size:13px;margin-left:auto;">Eliminar</button>
            <button onclick="window.resetClaveUsuario('${u}')" class="btn btn-contingencia" style="padding:2px 8px;font-size:13px;margin-left:6px;">Reset clave</button>
          </li>`;
        });
        html += '</ul>';
        document.getElementById('usuariosSidebarLista').innerHTML = html;
      });
    }
    
    window.agregarUsuario = function() {
  const usuario = document.getElementById('nuevoUsuario').value.trim().toLowerCase();
  const rol = document.getElementById('nuevoRol').value;
  if (!usuario) {
    Swal.fire('Campo requerido', 'Debes ingresar un nombre de usuario.', 'warning');
    return;
  }
  db.ref('usuarios/' + usuario).once('value', snap => {
    if (snap.exists()) {
      Swal.fire('Usuario existente', 'Ese usuario ya existe.', 'warning');
    } else {
      db.ref('usuarios/' + usuario).set({
        clave: '123',
        rol: rol,
        conectado: false
      }, err => {
        if (err) Swal.fire('Error', 'No se pudo agregar el usuario.', 'error');
        else {
          Swal.fire('¬°Listo!', 'Usuario agregado correctamente. Clave por defecto: 123', 'success');
          document.getElementById('nuevoUsuario').value = '';
          document.getElementById('nuevoRol').value = 'usuario';
          poblarSidebarUsuarios();
        }
      });
    }
  });
};
    window.eliminarUsuario = function(usuario) {
    Swal.fire({
    title: `¬øEliminar usuario "${usuario}"?`,
    text: 'Esto eliminar√° el usuario, pero NO sus registros hist√≥ricos.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
    }).then((result) => {
    if (result.isConfirmed) {
      db.ref('usuarios/' + usuario).remove(err => {
        if (err) return Swal.fire('Error', 'No se pudo eliminar el usuario.', 'error');
        Swal.fire('Eliminado', 'Usuario eliminado correctamente.', 'success');
        poblarSidebarUsuarios();
        });
      }
    });
  };

  window.resetClaveUsuario = function(usuario) {
  Swal.fire({
    title: `Resetear clave de "${usuario}"`,
    text: '¬øSeguro que deseas resetear la clave de este usuario? Se establecer√° como "123".',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, resetear',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      db.ref('usuarios/' + usuario + '/clave').set('123', err => {
        if (err) return Swal.fire('Error', 'No se pudo resetear la clave.', 'error');
        Swal.fire('Listo', 'La clave fue reseteada a "123".', 'success');
      });
    }
  });
};

    function mostrarPanelAdmin() {
      db.ref('registros').once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registros = Object.entries(data).map(([key, reg]) => ({ ...reg, _key: key }));

        // Agrupar por nombre de usuario
        const resumenPorUsuario = {};
        let totalRegistros = 0, totalMontos = 0;
        registros.forEach(r => {
          const nombre = r.nombre || '-';
          if (!resumenPorUsuario[nombre]) resumenPorUsuario[nombre] = { count: 0, monto: 0 };
          let montoIndividual = 0;
          if (r.monto && !isNaN(r.monto)) {
            montoIndividual = parseFloat(r.monto);
          } else if (r.duracion) {
            const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
            if (match) {
            const totalMin = parseInt(match[1]) * 60 + parseInt(match[2]);
            montoIndividual = totalMin * 0.025;
          }
        }
        resumenPorUsuario[nombre].monto += montoIndividual;
        totalMontos += montoIndividual;

          resumenPorUsuario[nombre].count++;
          totalRegistros++;
        });

        // Tabla resumen SOLO suma el monto guardado, no recalcula por tiempo
        let resumenHtml = `
<div style='overflow-x:auto; margin-bottom:18px;'>
  <h3 style='margin:0 0 8px 0;font-size:1.3rem;'>Resumen General</h3>
  <table style='border-collapse:collapse;width:100%;min-width:400px;'>
    <thead>
      <tr style='background:#f7fafd;'>
        <th style='border:1px solid #ccc;padding:8px;'>Nombre</th>
        <th style='border:1px solid #ccc;padding:8px;'>Registros</th>
        <th style='border:1px solid #ccc;padding:8px;'>Monto Total (USDT)</th>
      </tr>
    </thead>
    <tbody>
`;
        Object.entries(resumenPorUsuario).forEach(([nombre, data]) => {
          resumenHtml += `
            <tr>
              <td style='border:1px solid #ccc;padding:8px;cursor:pointer;color:#357abd;font-weight:600;text-decoration:underline;' onclick="window.mostrarDetalleUsuario('${nombre.replace(/'/g, "\\'")}')">${nombre}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${data.count}</td>
              <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${data.monto.toFixed(3)}</td>
            </tr>
          `;
        });
        resumenHtml += `
        </tbody>
      </table>
    </div>
    `;
        let totalUSDT = totalMontos.toFixed(3);
        resumenHtml += `<div style='background:#f7fafd;border-radius:12px;padding:18px 28px;box-shadow:0 2px 10px #4a90e220;display:flex;flex-direction:column;align-items:center;min-width:170px;margin-bottom:18px;'>`
          + `<span style='font-size:1.1rem;color:#357abd;font-weight:600;'>Monto total</span>`
          + `<span style='font-size:2.2rem;font-weight:bold;color:#357abd;margin-top:4px;'>${totalUSDT} USDT</span>`
          + `</div>`;
        let eliminarBtn = `<button onclick='window.eliminarTodosRegistrosGlobales()' class='btn btn-eliminar'>üóëÔ∏è Eliminar todos los registros</button>`;
        document.getElementById('adminResumen').innerHTML = eliminarBtn + resumenHtml;
        document.getElementById('adminRegistros').innerHTML = '';
        document.getElementById('adminModal').style.display = 'flex';
        poblarSidebarUsuarios();
        window._registrosAdmin = registros;
      });
    }

    function mostrarDetalleUsuario(nombre) {
      const registros = (window._registrosAdmin || []).filter(r => (r.nombre || '-') === nombre);
      let html = `
    <button class="btn" onclick="window.mostrarPanelAdmin()" style="margin-bottom:18px;">‚¨ÖÔ∏è Volver al resumen</button>
    <h3 style="margin-top:0;margin-bottom:14px;font-size:1.2rem;color:#357abd;">Registros de <span style="color:#43b97b">${nombre}</span></h3>
    <div style='overflow-x:auto;'>
      <table style='border-collapse:collapse;width:100%;min-width:400px;'>
        <thead>
          <tr style='background:#f7fafd;'>
            <th style='border:1px solid #ccc;padding:8px;'>Motivo</th>
            <th style='border:1px solid #ccc;padding:8px;'>Fecha</th>
            <th style='border:1px solid #ccc;padding:8px;'>Inicio</th>
            <th style='border:1px solid #ccc;padding:8px;'>Fin</th>
            <th style='border:1px solid #ccc;padding:8px;'>Duraci√≥n</th>
            <th style='border:1px solid #ccc;padding:8px;'>Monto (USDT)</th>
            <th style='border:1px solid #ccc;padding:8px;'>Eliminar</th>
          </tr>
        </thead>
        <tbody>
  `;
  registros.forEach(r => {
    // Solo mostrar el monto guardado, sin sumar por tiempo
    let montoMostrar = '-';
if (r.monto && !isNaN(r.monto)) {
  montoMostrar = parseFloat(r.monto).toFixed(3);
} else if (r.duracion) {
  const match = r.duracion.match(/(\d+)h\s+(\d+)m/);
  if (match) {
    const totalMin = parseInt(match[1]) * 60 + parseInt(match[2]);
    montoMostrar = (totalMin * 0.025).toFixed(3); // c√°lculo estimado si no existe monto directo
  }
}

    html += `
      <tr>
        <td style='border:1px solid #ccc;padding:8px;'>${r.motivo || '-'}</td>
        <td style='border:1px solid #ccc;padding:8px;'>${r.dia || '-'}</td>
        <td style='border:1px solid #ccc;padding:8px;'>${r.inicio || '-'}</td>
        <td style='border:1px solid #ccc;padding:8px;'>${r.fin || '-'}</td>
        <td style='border:1px solid #ccc;padding:8px;'>${r.duracion || '-'}</td>
        <td style='border:1px solid #ccc;padding:8px;text-align:right;'>${montoMostrar}</td>
        <td style='border:1px solid #ccc;padding:8px;text-align:center;'>
          <button onclick="window.eliminarRegistroEspecifico('${r._key}','${nombre.replace(/'/g, "\\'")}')" class="btn btn-eliminar" title="Eliminar registro" style="padding:4px 10px;font-size:17px;"><span style="pointer-events:none;">üóëÔ∏è</span></button>
        </td>
      </tr>
    `;
  });
  html += `
        </tbody>
      </table>
    </div>
  `;
  document.getElementById('adminResumen').innerHTML = html;
  document.getElementById('adminRegistros').innerHTML = '';
}

    function eliminarRegistroEspecifico(key, nombre) {
      Swal.fire({
        title: '¬øEliminar registro?',
        text: '¬øSeguro que deseas eliminar este registro?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref('registros/' + key).remove(err => {
            if (err) return Swal.fire('Error', 'No se pudo eliminar el registro.', 'error');
            Swal.fire('Eliminado', 'Registro eliminado correctamente.', 'success');
            window.mostrarDetalleUsuario(nombre);
          });
        }
      });
    }

    // --- Funciones globales para HTML ---
    window.eliminarTodosRegistrosGlobales = function() {
      Swal.fire({
        title: '¬øEliminar TODOS los registros?',
        text: 'Esto eliminar√° todos los registros del sistema (solo desde el panel admin).',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar todo',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref('registros').remove(err => {
            if (err) return Swal.fire('Error', 'No se pudo eliminar.', 'error');
            Swal.fire('Eliminado', 'Todos los registros han sido eliminados.', 'success');
            if (typeof window.mostrarPanelAdmin === 'function') window.mostrarPanelAdmin();
          });
        }
      });
    };
    window.mostrarPanelAdmin = mostrarPanelAdmin;
    window.mostrarDetalleUsuario = mostrarDetalleUsuario;
    window.eliminarRegistroEspecifico = eliminarRegistroEspecifico;

    function mostrarLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('loginUsuario').focus();
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginClave').value = '';
}

    // --- Inicializaci√≥n ---
    window.addEventListener('DOMContentLoaded', () => {
      usuarioActual = localStorage.getItem('usuarioActual') || null;
      if (!usuarioActual) {
        mostrarLogin();
        setAdminBtnByRol(null);
      }
      const inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) {
        try {
          const data = JSON.parse(inicioPend);
          if (data && data.inicio) {
            inicio = new Date(data.inicio);
            document.getElementById("nombre").value = data.nombre || '';
            document.getElementById("motivo").value = data.motivo || '';
            setInfoInicio(inicio);
          }
        } catch(e) {}
      }
      aplicarModoOscuro();
      // Eventos login
      document.getElementById('loginBtn').onclick = loginUsuario;
      ['loginUsuario', 'loginClave'].forEach(id => {
        document.getElementById(id).addEventListener('keydown', e => {
          if (e.key === 'Enter') loginUsuario();
        });
      });
      document.getElementById('darkModeToggle').onclick = () => {
        const dark = !(localStorage.getItem('modo_oscuro') === '1');
        localStorage.setItem('modo_oscuro', dark ? '1' : '0');
        aplicarModoOscuro();
      };
      // Eliminar historial
      window.eliminarHistorial = function() {
        if (confirm('¬øSeguro que deseas eliminar tu historial?')) {
          const usuario = usuarioActual || getInputValue('nombre').toLowerCase();
          db.ref('registros').once('value', snapshot => {
            const data = snapshot.val() || {};
            Object.entries(data).forEach(([key, registro]) => {
              if (registro.nombre && registro.nombre.toLowerCase() === usuario) {
                db.ref('registros/' + key).remove();
              }
            });
            document.getElementById('historial').innerHTML = "<strong>Hist√≥rico de tiempos:</strong><div id='resumenHoras'></div>";
            Swal.fire('Eliminado', 'Tu historial ha sido eliminado.', 'success');
          });
          localStorage.removeItem('historial_registros');
        }
      };
    });

    // --- Cambiar clave usuario ---
    document.getElementById('btnCambiarClave').onclick = async function() {
      const { value: formValues } = await Swal.fire({
        title: 'Cambiar clave',
        html:
          '<input id="swal-usuario" class="swal2-input" placeholder="Usuario">' +
          '<input id="swal-clave-actual" type="password" class="swal2-input" placeholder="Clave actual">' +
          '<input id="swal-nueva-clave" type="password" class="swal2-input" placeholder="Nueva clave">',
        focusConfirm: false,
        preConfirm: () => [
          document.getElementById('swal-usuario').value.trim().toLowerCase(),
          document.getElementById('swal-clave-actual').value.trim(),
          document.getElementById('swal-nueva-clave').value.trim()
        ],
        confirmButtonText: 'Guardar',
        showCancelButton: true,
        cancelButtonText: 'Cancelar'
      });

      if (!formValues) return;
      const [usuario, claveActual, nuevaClave] = formValues;
      if (!usuario || !claveActual || !nuevaClave) {
        Swal.fire('Campos requeridos', 'Completa todos los campos.', 'warning');
        return;
      }

      db.ref('usuarios/' + usuario).once('value', snap => {
        const data = snap.val();
        if (!data) return Swal.fire('Error', 'Usuario no encontrado.', 'error');
        if (data.clave !== claveActual) return Swal.fire('Error', 'La clave actual es incorrecta.', 'error');
        db.ref('usuarios/' + usuario + '/clave').set(nuevaClave, err => {
          if (err) Swal.fire('Error', 'No se pudo cambiar la clave.', 'error');
          else Swal.fire('¬°Listo!', 'Clave cambiada correctamente.', 'success');
        });
      });
    };

    // --- Exportar registros a Excel ---
    document.getElementById('descargarExcelAdminBtn').onclick = function() {
      db.ref('registros').once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const registros = Object.values(data);
        if (registros.length === 0) return Swal.fire('Sin datos', 'No hay registros para exportar.', 'info');
        let totalMontos = 0;
        const rows = registros.map(r => {
          let montoExcel = '';
          if (r.monto && !isNaN(r.monto)) {
            totalMontos += parseFloat(r.monto);
            montoExcel = parseFloat(r.monto).toFixed(3);
          }
          return {
            Nombre: r.nombre || '',
            Motivo: r.motivo || '',
            'Monto (USDT)': montoExcel,
            D√≠a: r.dia || '',
            Inicio: r.inicio || '',
            Fin: r.fin || '',
            Duraci√≥n: r.duracion || ''
          };
        });
        const totalUSDTExcel = totalMontos.toFixed(3);
        rows.push({
          Nombre: '',
          Motivo: '',
          'Monto (USDT)': '',
          D√≠a: '',
          Inicio: '',
          Fin: 'TOTAL USDT',
          Duraci√≥n: totalUSDTExcel
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Registros");
        XLSX.writeFile(wb, "registros_completos.xlsx");
      });
    };

    // --- Logout ---
    document.getElementById('logoutBtn').onclick = function() {
  Swal.fire({
    title: '¬øCerrar sesi√≥n?',
    text: '¬øSeguro que deseas cerrar sesi√≥n?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'S√≠, cerrar sesi√≥n',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      if (usuarioActual) {
        db.ref('usuarios/' + usuarioActual + '/conectado').set(false);
      }
      location.reload();
    }
  });
};

    // --- Guardar registro pendiente antes de salir ---
    window.addEventListener('beforeunload', function () {
      const inicioPend = localStorage.getItem('inicio_pendiente');
      if (inicioPend) {
        try {
          const data = JSON.parse(inicioPend);
          if (data && data.inicio && data.nombre && data.motivo) {
            const inicio = new Date(data.inicio);
            const fin = new Date();
            const finVE = new Date(fin.toLocaleString("en-US", { timeZone: "America/Caracas" }));
            let motivo = data.motivo;
            let monto = 0;
            if (data.contingencia) {
              motivo += (motivo ? ' | ' : '') + 'Contingencia: 10 USDT';
              monto += 10;
            }
            const hoy = finVE;
            const dia = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
            const registro = {
              nombre: data.nombre,
              motivo,
              dia,
              inicio: formatearHora(inicio),
              fin: formatearHora(finVE),
              duracion: calcularDuracionTexto(inicio, finVE)
            };
            if (monto > 0) registro.monto = monto.toFixed(3);
            db.ref('registros').push(registro);
            localStorage.removeItem('inicio_pendiente');
          }
        } catch (err) {}
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
  // Mostrar el modal al hacer click en el bot√≥n
  const btnMostrar = document.getElementById('btnMostrarCalculoTiempoAdmin');
  if (btnMostrar) {
    btnMostrar.onclick = function() {
      document.getElementById('calculoTiempoBoxAdmin').style.display = 'flex';
      cargarUsuariosEnSelectAdmin();
    };
  }
  const horas = document.getElementById('calculoHorasAdmin');
  const minutos = document.getElementById('calculoMinutosAdmin');
  if (horas) horas.oninput = actualizarCalculoResultadoAdmin;
  if (minutos) minutos.oninput = actualizarCalculoResultadoAdmin;
  // A√±adir al historial
  const btnAgregar = document.getElementById('btnAgregarCalculoHistorialAdmin');
  if (btnAgregar) {
    btnAgregar.onclick = function() {
      const usuario = document.getElementById('calculoUsuarioAdmin').value;
      const motivo = document.getElementById('calculoMotivoAdmin').value.trim();
      const horas = parseInt(document.getElementById('calculoHorasAdmin').value) || 0;
      const minutos = parseInt(document.getElementById('calculoMinutosAdmin').value) || 0;
      const totalMin = horas * 60 + minutos;
      const usdt = totalMin * 0.025;
      if (!usuario) return Swal.fire('Usuario requerido', 'Selecciona un usuario.', 'warning');
      if (!motivo) return Swal.fire('Motivo requerido', 'Ingresa un motivo.', 'warning');
      if (totalMin <= 0) return Swal.fire('Tiempo requerido', 'Ingresa horas o minutos v√°lidos.', 'warning');
      const hoy = new Date();
      const fecha = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
      db.ref('registros').push({
        nombre: usuario,
        motivo: motivo,
        monto: usdt.toFixed(3),
        dia: fecha,
        duracion: `${horas}h ${minutos}m 0s`
      }, err => {
        if (err) return Swal.fire('Error', 'No se pudo guardar el registro.', 'error');
        Swal.fire('¬°Listo!', 'Registro a√±adido al historial.', 'success');
        document.getElementById('calculoTiempoBoxAdmin').style.display = 'none';
        document.getElementById('calculoMotivoAdmin').value = '';
        document.getElementById('calculoHorasAdmin').value = '';
        document.getElementById('calculoMinutosAdmin').value = '';
        document.getElementById('calculoUsuarioAdmin').value = '';
        document.getElementById('calculoResultadoAdmin').textContent = '';
      });
    };
  }
});


function cargarUsuariosEnSelectAdmin() {
  const select = document.getElementById('calculoUsuarioAdmin');
  select.innerHTML = '<option value="">Selecciona usuario</option>';
  db.ref('usuarios').once('value', snap => {
    const data = snap.val() || {};
    Object.keys(data).forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      select.appendChild(opt);
    });
  });
}

function actualizarCalculoResultadoAdmin() {
  const horas = parseInt(document.getElementById('calculoHorasAdmin').value) || 0;
  const minutos = parseInt(document.getElementById('calculoMinutosAdmin').value) || 0;
  const totalMin = horas * 60 + minutos;
  const usdt = totalMin * 0.025;
  document.getElementById('calculoResultadoAdmin').textContent =
    totalMin > 0 ? `Equivale a ${usdt.toFixed(3)} USDT` : '';
}
  </script>
</body>
</html>
